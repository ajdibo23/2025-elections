<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Election Tracker</title>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    .race-card.dem {
      border-left: 6px solid #3498db;
    }

    .race-card.rep {
      border-left: 6px solid #ed4245;
    }

    .race-card.ind {
      border-left: 6px solid #95a5a6;
    }

    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      min-height: 100vh;
      padding: 20px;
    }

    .container {
      max-width: 1400px;
      margin: 0 auto;
    }

    header {
      background: white;
      border-radius: 12px;
      padding: 30px;
      margin-bottom: 30px;
      box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2);
    }

    h1 {
      font-size: 2.5em;
      margin-bottom: 20px;
      color: #333;
    }

    .controls {
      display: flex;
      gap: 15px;
      flex-wrap: wrap;
    }

    select,
    input[type="text"],
    input[type="date"] {
      padding: 12px 16px;
      border: 2px solid #e0e0e0;
      border-radius: 8px;
      font-size: 16px;
      transition: all 0.3s;
    }

    select:focus,
    input:focus {
      outline: none;
      border-color: #667eea;
    }

    #stateSelect {
      flex: 1;
      min-width: 200px;
    }

    #raceSearch {
      flex: 2;
      min-width: 250px;
    }

    .races-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(350px, 1fr));
      gap: 20px;
    }

    .race-card {
      background: white;
      border-radius: 12px;
      padding: 20px;
      cursor: pointer;
      transition: all 0.3s;
      box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
    }

    .race-card:hover {
      transform: translateY(-5px);
      box-shadow: 0 8px 25px rgba(0, 0, 0, 0.15);
    }

    .race-title {
      font-size: 1.3em;
      font-weight: bold;
      margin-bottom: 10px;
      color: #333;
    }

    .race-info {
      color: #666;
      margin: 5px 0;
      font-size: 0.95em;
    }

    .race-preview {
      margin-top: 15px;
      padding-top: 15px;
      border-top: 2px solid #f0f0f0;
    }

    .preview-title {
      font-size: 0.85em;
      font-weight: bold;
      color: #888;
      margin-bottom: 8px;
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }

    .preview-candidate {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 8px;
      margin: 5px 0;
      border-radius: 6px;
      font-size: 0.95em;
    }

    .preview-candidate.dem {
      background: rgba(52, 152, 219, 0.1);
      border-left: 4px solid #3498db;
    }

    .preview-candidate.rep {
      background: rgba(237, 66, 69, 0.1);
      border-left: 4px solid #ed4245;
    }

    .preview-candidate.ind {
      background: rgba(149, 165, 166, 0.1);
      border-left: 4px solid #95a5a6;
    }

    .candidate-name-preview {
      font-weight: 600;
      color: #333;
    }

    .candidate-votes-preview {
      display: flex;
      flex-direction: column;
      align-items: flex-end;
    }

    .vote-count-preview {
      font-weight: bold;
      color: #333;
    }

    .vote-percent-preview {
      font-size: 0.85em;
      color: #666;
    }

    .loading,
    .error {
      background: white;
      border-radius: 12px;
      padding: 40px;
      text-align: center;
      font-size: 1.2em;
      color: #666;
      grid-column: 1 / -1;
    }

    .error {
      color: #e74c3c;
    }

    .modal {
      display: none;
      position: fixed;
      z-index: 1000;
      left: 0;
      top: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, 0.7);
      overflow: auto;
    }

    .modal-content {
      background: white;
      margin: 50px auto;
      padding: 0;
      width: 95%;
      max-width: 1200px;
      border-radius: 12px;
      position: relative;
      max-height: 90vh;
      overflow-y: auto;
    }

    .close-btn {
      position: sticky;
      top: 0;
      right: 0;
      float: right;
      font-size: 35px;
      font-weight: bold;
      background: #e74c3c;
      color: white;
      border: none;
      width: 50px;
      height: 50px;
      border-radius: 0 12px 0 12px;
      cursor: pointer;
      z-index: 10;
    }

    .close-btn:hover {
      background: #c0392b;
    }

    #modalBody {
      padding: 30px;
    }

    .race-detail-wrapper h2 {
      font-size: 2em;
      margin-bottom: 20px;
      color: #333;
    }

    .stats {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
      gap: 15px;
      margin-bottom: 30px;
    }

    .stat-box {
      background: #f8f9fa;
      padding: 20px;
      border-radius: 8px;
      text-align: center;
    }

    .stat-label {
      font-size: 0.85em;
      color: #666;
      margin-bottom: 8px;
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }

    .stat-value {
      font-size: 1.5em;
      font-weight: bold;
      color: #333;
    }

    .candidates-list {
      margin-bottom: 30px;
    }

    .candidate {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 15px;
      margin: 10px 0;
      border-radius: 8px;
      border-left: 5px solid;
    }

    .candidate.dem {
      background: rgba(52, 152, 219, 0.1);
      border-color: #3498db;
    }

    .candidate.rep {
      background: rgba(237, 66, 69, 0.1);
      border-color: #ed4245;
    }

    .candidate.ind {
      background: rgba(149, 165, 166, 0.1);
      border-color: #95a5a6;
    }

    .candidate-name {
      font-size: 1.2em;
      font-weight: bold;
      color: #333;
    }

    .candidate-party {
      color: #666;
      font-size: 0.9em;
    }

    .candidate-votes {
      text-align: right;
    }

    .vote-count {
      font-size: 1.3em;
      font-weight: bold;
      color: #333;
    }

    .vote-percent {
      color: #666;
    }

    .incumbent-badge,
    .called-badge {
      display: inline-block;
      padding: 3px 8px;
      border-radius: 4px;
      font-size: 0.7em;
      font-weight: bold;
      margin-left: 8px;
    }

    .incumbent-badge {
      background: #f39c12;
      color: white;
    }

    .called-badge {
      background: #27ae60;
      color: white;
    }

    .map-container {
      margin-top: 30px;
    }

    .map-container h3 {
      margin-bottom: 15px;
      color: #333;
    }

    .county-map {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
      gap: 15px;
    }

    .county {
      background: white;
      border: 2px solid #e0e0e0;
      border-radius: 8px;
      padding: 15px;
      transition: all 0.3s;
      position: relative;
    }

    .county:hover {
      box-shadow: 0 5px 20px rgba(0, 0, 0, 0.15);
      transform: translateY(-2px);
      z-index: 10;
    }

    .county.dem {
      border-left: 5px solid #3498db;
    }

    .county.rep {
      border-left: 5px solid #ed4245;
    }

    .county.ind {
      border-left: 5px solid #95a5a6;
    }

    .county-header {
      margin-bottom: 12px;
      padding-bottom: 12px;
      border-bottom: 2px solid #f0f0f0;
    }

    .county-name {
      font-size: 1.1em;
      font-weight: bold;
      color: #333;
      margin-bottom: 5px;
    }

    .county-precincts,
    .county-total-votes {
      font-size: 0.85em;
      color: #666;
      margin: 3px 0;
    }

    .county-candidates {
      display: block;
      animation: fadeIn 0.3s;
    }

    @keyframes fadeIn {
      from {
        opacity: 0;
      }

      to {
        opacity: 1;
      }
    }

    .county-candidate {
      padding: 8px;
      margin: 5px 0;
      border-radius: 4px;
      font-size: 0.9em;
    }

    .county-candidate.dem {
      background: rgba(52, 152, 219, 0.1);
    }

    .county-candidate.rep {
      background: rgba(237, 66, 69, 0.1);
    }

    .county-candidate.ind {
      background: rgba(149, 165, 166, 0.1);
    }

    @media (max-width: 768px) {
      .races-grid {
        grid-template-columns: 1fr;
      }

      .county-map {
        grid-template-columns: 1fr;
      }
    }
  </style>
</head>

<body>
  <div class="container">
    <header>
      <h1>üó≥Ô∏è Election Tracker</h1>
      <div class="controls">
        <select id="stateSelect"></select>
        <input type="date" id="dateSelect" value="2025-11-04" style="display: none;">
        <input type="text" id="raceSearch" placeholder="Search races..." />
      </div>
    </header>

    <div id="racesContainer" class="races-grid"></div>
  </div>

  <div id="raceModal" class="modal">
    <div class="modal-content">
      <button class="close-btn" onclick="closeModal()">&times;</button>
      <div id="modalBody"></div>
    </div>
  </div>

  <script>
    let currentRaces = [];

    const stateNames = [
      'Arizona', 'Arkansas', 'California', 'Colorado', 'Connecticut', 'Florida', 'Georgia',
      'Idaho', 'Iowa', 'Kansas', 'Maine', 'Maryland', 'Massachusetts', 'Michigan', 'Minnesota',
      'Mississippi', 'Montana', 'New Hampshire', 'New Jersey', 'New Mexico', 'New York',
      'North Carolina', 'Ohio', 'Pennsylvania', 'Rhode Island', 'South Carolina', 'Texas',
      'Utah', 'Virginia', 'Washington', 'Wyoming'
    ];

    stateNames.forEach(state => {
      document.getElementById('stateSelect').innerHTML += `<option value="${state.replace(' ', '_')}">${state}</option>`
    });

    async function loadRaces() {
      const state = document.getElementById('stateSelect').value;
      const date = document.getElementById('dateSelect').value;
      const container = document.getElementById('racesContainer');

      container.innerHTML = '<div class="loading">Loading races...</div>';

      try {
        const url = `https://election-night.decisiondeskhq.com/dates/${date}/${state}.json`;
        const response = await fetch(url);
        const data = await response.json();

        const racesWithPreviews = await Promise.all((data.races || []).map(async (race) => {
          try {
            const detailResponse = await fetch(`https://embed-api.ddhq.io/v2/races/${race.race_id}`);
            const detailData = await detailResponse.json();
            return { ...race, previewData: detailData };
          } catch {
            return race;
          }
        }));

        racesWithPreviews.sort((a, b) => {
          const aVotes = a.previewData?.topline_results?.total_votes || 0;
          const bVotes = b.previewData?.topline_results?.total_votes || 0;
          return bVotes - aVotes;
        });

        currentRaces = racesWithPreviews;
        filterRaces();
      } catch (error) {
        container.innerHTML = `<div class="error">Error loading races: ${error.message}</div>`;
      }
    }

    function filterRaces() {
      const searchTerm = document.getElementById('raceSearch').value.toLowerCase();
      let filteredRaces = currentRaces;

      if (searchTerm) {
        filteredRaces = currentRaces.filter(race => {
          if (race.display_name.toLowerCase().includes(searchTerm) ||
            race.office.toLowerCase().includes(searchTerm) ||
            race.election_type.toLowerCase().includes(searchTerm)) {
            return true;
          }

          if (race.previewData && race.previewData.candidates) {
            return race.previewData.candidates.some(candidate =>
              `${candidate.first_name} ${candidate.last_name}`.toLowerCase().includes(searchTerm) ||
              candidate.party_name.toLowerCase().includes(searchTerm)
            );
          }

          return false;
        });
      }

      displayRaces(filteredRaces);
    }

    let currentOpen = null;

    function displayRaces(races) {
      const container = document.getElementById('racesContainer');
      if (races.length === 0) {
        container.innerHTML = '<div class="loading">No races found.</div>';
        return;
      }

      container.innerHTML = races.map(race => {
        let previewHtml = '';
        let partyClass = 'ind';
        let calledBadge = '';

        if (race.previewData && race.previewData.candidates?.length > 0) {
          const sorted = race.previewData.candidates.sort((a, b) => b.votes - a.votes);
          const leader = sorted[0];
          partyClass = leader.party_name.toLowerCase().includes('democrat') ? 'dem'
            : leader.party_name.toLowerCase().includes('republican') ? 'rep' : 'ind';
          if (leader.called) calledBadge = '<span class="called-badge">CALLED</span>';

          const topCandidates = sorted.slice(0, 2);
          previewHtml = `
        <div class="race-preview">
          <div class="preview-title">Leading Candidates</div>
          ${topCandidates.map(cand => {
            const candParty = cand.party_name.toLowerCase().includes('democrat') ? 'dem'
              : cand.party_name.toLowerCase().includes('republican') ? 'rep' : 'ind';
            return `
              <div class="preview-candidate ${candParty}">
                <span class="candidate-name-preview">${cand.first_name} ${cand.last_name}</span>
                <div class="candidate-votes-preview">
                  <span class="vote-count-preview">${cand.votes.toLocaleString()}</span>
                  <span class="vote-percent-preview">${cand.percent.toFixed(1)}%</span>
                </div>
              </div>`;
          }).join('')}
        </div>`;
        }

        return `
  <div class="race-card ${partyClass}" onclick="openRaceDetail(${race.race_id})">
    <div class="race-title">${race.display_name} ${calledBadge}</div>
    <div class="race-info">üìç ${race.office}${race.district ? ' - District ' + race.district : ''}</div>
    <div class="race-info">üóìÔ∏è ${race.election_type}</div>
    ${previewHtml}
  </div>`;
      }).join('');
    }

    async function openRaceDetail(raceId) {
      const modal = document.getElementById('raceModal');
      const modalBody = document.getElementById('modalBody');

      const url = new URL(window.location);
      url.searchParams.set('race', raceId);
      window.history.pushState({}, '', url);

      if (modal.style.display !== 'block') {
        modalBody.innerHTML = '<div class="loading">Loading race details...</div>';
        modal.style.display = 'block';
      }

      try {
        const response = await fetch(`https://embed-api.ddhq.io/v2/races/${raceId}`);
        const race = await response.json();

        displayRaceDetail(race);

        clearInterval(currentOpen);

        currentOpen = setInterval(async function () {
          try {
            const refreshResponse = await fetch(`https://embed-api.ddhq.io/v2/races/${raceId}`);
            const refreshRace = await refreshResponse.json();
            displayRaceDetail(refreshRace);
          } catch (err) {
            console.error('Error refreshing race:', err);
          }
        }, 5000);

      } catch (error) {
        modalBody.innerHTML = `<div class="error">Error loading race details: ${error.message}</div>`;
      }
    }

    function displayRaceDetail(race) {
      const modalBody = document.getElementById('modalBody');
      const hasCounties = race.vcus && race.vcus.length > 0;

      if (!modalBody.innerHTML.includes('race-detail-wrapper')) {
        let html = `
          <div class="race-detail-wrapper">
            <h2>${race.title}</h2>
            <div class="stats">
              <div class="stat-box">
                <div class="stat-label">Total Votes</div>
                <div class="stat-value" id="totalVotes">${race.topline_results.total_votes.toLocaleString()}</div>
              </div>
              <div class="stat-box">
                <div class="stat-label">Reporting</div>
                <div class="stat-value" id="reportingPercent">${race.topline_results.precincts?.percent?.toFixed(1) || 0}%</div>
              </div>
              <div class="stat-box">
                <div class="stat-label">Precincts</div>
                <div class="stat-value" id="precinctsCount">${race.topline_results.precincts?.reporting || 0} / ${race.topline_results.precincts?.total || 0}</div>
              </div>
              <div class="stat-box">
                <div class="stat-label">Poll Close</div>
                <div class="stat-value">${new Date(race.poll_close_time).toLocaleTimeString()}</div>
              </div>
            </div>

            <h3>Candidates</h3>
            <div class="candidates-list" id="candidatesList">
              ${race.candidates.sort((a, b) => b.votes - a.votes).map(cand => {
          const partyClass = cand.party_name.toLowerCase().includes('democrat') ? 'dem' :
            cand.party_name.toLowerCase().includes('republican') ? 'rep' : 'ind';
          return `
                  <div class="candidate ${partyClass}" id="cand-${cand.cand_id}">
                    <div>
                      <div class="candidate-name">
                        ${cand.first_name} ${cand.last_name}
                        ${cand.incumbent ? '<span class="incumbent-badge">INCUMBENT</span>' : ''}
                        ${cand.called ? '<span class="called-badge">CALLED</span>' : ''}
                      </div>
                      <div class="candidate-party">${cand.party_name}</div>
                    </div>
                    <div class="candidate-votes">
                      <div class="vote-count">${cand.votes.toLocaleString()}</div>
                      <div class="vote-percent">${cand.percent.toFixed(1)}%</div>
                    </div>
                  </div>
                `;
        }).join('')}
            </div>

            ${hasCounties ? `
              <div class="map-container">
                <h3>County Results (Hover for Details)</h3>
                <input type="text" id="countySearch" placeholder="Search counties..." style="margin-bottom:10px;padding:10px;width:100%;box-sizing:border-box;border:2px solid #e0e0e0;border-radius:8px;font-size:16px;" />
                <div class="county-map" id="countyMap"></div>
              </div>
            ` : ''}
          </div>
        `;
        modalBody.innerHTML = html;

        if (hasCounties) {
          renderAllCounties(race);
          setupCountySearch();
        }
      } else {
        document.getElementById('totalVotes').textContent = race.topline_results.total_votes.toLocaleString();
        document.getElementById('reportingPercent').textContent = `${race.topline_results.precincts?.percent?.toFixed(1) || 0}%`;
        document.getElementById('precinctsCount').textContent = `${race.topline_results.precincts?.reporting || 0} / ${race.topline_results.precincts?.total || 0}`;

        race.candidates.forEach(cand => {
          const el = document.getElementById(`cand-${cand.cand_id}`);
          if (el) {
            el.querySelector('.vote-count').textContent = cand.votes.toLocaleString();
            el.querySelector('.vote-percent').textContent = cand.percent.toFixed(1) + '%';
          }
        });

        if (hasCounties) {
          renderAllCounties(race);
        }
      }
    }

    function renderAllCounties(race) {
      const countyMap = document.getElementById('countyMap');
      if (!countyMap) return;

      race.vcus.sort((a, b) => b.total_votes - a.total_votes);

      countyMap.innerHTML = race.vcus.map(county => renderCounty(county, race.candidates)).join('');

      const searchInput = document.getElementById('countySearch');
      if (searchInput && searchInput.value) {
        const event = new Event('input');
        searchInput.dispatchEvent(event);
      }
    }

    function setupCountySearch() {
      const searchInput = document.getElementById('countySearch');
      if (!searchInput) return;

      searchInput.addEventListener('input', () => {
        const query = searchInput.value.toLowerCase();
        const counties = document.querySelectorAll('#countyMap .county');
        counties.forEach(county => {
          const name = county.getAttribute('data-county-name');
          if (name.includes(query)) {
            county.style.display = '';
          } else {
            county.style.display = 'none';
          }
        });
      });
    }

    function closeModal() {
      const modal = document.getElementById('raceModal');
      modal.style.display = 'none';
      clearInterval(currentOpen);

      const url = new URL(window.location);
      url.searchParams.delete('race');
      window.history.pushState({}, '', url);
    }

    window.onclick = function (event) {
      const modal = document.getElementById('raceModal');
      if (event.target === modal) {
        closeModal();
      }
    }

    function renderCounty(county, candidates) {
      const leadingCand = county.candidates.reduce((prev, curr) => curr.votes > prev.votes ? curr : prev);
      const candidate = candidates.find(c => c.cand_id === leadingCand.cand_id);
      const partyClass = candidate ?
        (candidate.party_name.toLowerCase().includes('democrat') ? 'dem' :
          candidate.party_name.toLowerCase().includes('republican') ? 'rep' : 'ind') : '';

      return `
        <div class="county ${partyClass}" data-county-name="${county.name.toLowerCase()}">
          <div class="county-header">
            <div class="county-name">${county.name}</div>
            <div class="county-precincts">${county.precincts?.reporting || 0} / ${county.precincts?.total || 0} precincts</div>
            <div class="county-total-votes">${county.total_votes.toLocaleString()} votes</div>
          </div>
          <div class="county-candidates">
            ${county.candidates.map(c => {
        const cand = candidates.find(rc => rc.cand_id === c.cand_id);
        const candPartyClass = cand ?
          (cand.party_name.toLowerCase().includes('democrat') ? 'dem' :
            cand.party_name.toLowerCase().includes('republican') ? 'rep' : 'ind') : '';
        return `
                <div class="county-candidate ${candPartyClass}">
                  <strong>${cand ? cand.first_name + ' ' + cand.last_name : 'Unknown'}</strong><br>
                  ${c.votes.toLocaleString()} votes (${c.percent.toFixed(1)}%)
                </div>
              `;
      }).join('')}
          </div>
        </div>
      `;
    }

    document.getElementById('stateSelect').addEventListener('change', function () {
      const state = document.getElementById('stateSelect').value;
      loadRaces();

      const url = new URL(window.location);
      url.searchParams.set('state', state);
      window.history.pushState({}, '', url);
    });
    
    document.getElementById('raceSearch').addEventListener('input', filterRaces);

    const params = new URLSearchParams(window.location.search);
    const state = params.get('state');
    const raceId = params.get('race');

    if (state) {
      document.getElementById('stateSelect').value = state;
    }
    loadRaces();

    if (raceId) {
      openRaceDetail(raceId);
    }
  </script>
</body>

</html>
